<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script>

		 window.addEventListener("load", function(evt) {

			 var output = document.getElementById("output");
			 var input = document.getElementById("input");
			 var playButton = document.getElementById("play");
			 var header = document.getElementById("header");

			 var ws;

			 var print = function(message) {
				 var d = document.createElement("div");
				 d.textContent = message;
				 output.appendChild(d);
				 d.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' })
//				 d.scrollIntoView()
			 };

			 var yodelBuffer;
			 var resBuffer = new Map();

			 var context = new (window.AudioContext || window.webkitAudioContext)();

			 function play(audioBuffer) {
				 const source = context.createBufferSource();
				 source.buffer = audioBuffer;
				 source.connect(context.destination);
				 source.start();
			 }

			 (function () {
				 'use strict';

				 const URL = "yodel.mp3"

				 window.fetch(URL)
					   .then(response => response.arrayBuffer())
					   .then(arrayBuffer => context.decodeAudioData(arrayBuffer,
																	audioBuffer => {
																		playButton.disabled = false;
																		yodelBuffer = audioBuffer;
																	},
																	error =>
																		console.error(error)
					   ))

				 function load(resURL) {
					 window.fetch(resURL)
						   .then(response => response.arrayBuffer())
						   .then(arrayBuffer => context.decodeAudioData(arrayBuffer,
																		audioBuffer => {
																			resBuffer.set(resURL, audioBuffer)
																		},
																		error =>
																			console.error(error)
						   ))
				 }

				 load("air00.mp3")
				 load("air01.mp3")
				 load("air02.mp3")
				 load("air03.mp3")
				 load("air04.mp3")
				 load("air05.mp3")
				 load("air06.mp3")
				 load("air07.mp3")
				 load("air08.mp3")
				 load("air09.mp3")
				 load("air10.mp3")
				 load("rad00.mp3")
				 load("rad01.mp3")
				 load("rad02.mp3")
				 load("rad03.mp3")
				 load("rad04.mp3")
				 load("rad05.mp3")
				 load("rad06.mp3")
				 load("rad07.mp3")
				 load("rad08.mp3")
				 load("rad09.mp3")
				 load("rad10.mp3")

				 playButton.onclick = function(evt) {
					 playButton.style.display = "none";
					 play(yodelBuffer);
					 return false;
				 };

			 }());

			 var enterfn = function(evt) {
				 if (ws) {
					 return false;
				 }
				 ws = new WebSocket("{{.}}");
				 ws.onopen = function(evt) {
					 header.style.display = "inline";
				 }
				 ws.onclose = function(evt) {
					 print("connection closed");
					 ws = null;
				 }
				 ws.onmessage = function(evt) {
					 header.style.display = "none";
					 var line = evt.data
					 print(line);
					 var firstWord = line.substr(0, line.indexOf(" "));
					 play(resBuffer.get(firstWord.concat(".mp3")));
					 //			document.getElementById(firstWord).click()
				 }
				 ws.onerror = function(evt) {
					 print("error: " + evt.data);
				 }
				 return false;
			 };

			 var exitfn = function(evt) {
				 if (!ws) {
					 return false;
				 }
				 ws.send(input.value);
				 return false;
			 };

			 var e = document.getElementById("open");
			 if (e) { e.onclick = enterfn };
			 var e = document.getElementById("send")
			 if (e) { e.onclick = exitfn };
			 var e = document.getElementById("close")
			 if (e) {
				 e.onclick = function(evt) {
					 if (!ws) {
						 return false;
					 }
					 ws.close();
					 return false;
				 };
			 };

			 enterfn();

		 });
		</script>
	</head>
	<body>
		<table width=100% height=100%>
			<tr>
				<td>
					<img src="safecast-small.png"/>
				</td>
			</tr>
		</table>
		<div id="header" hidden>One moment please, as we wait for the next Safecast event...</div>
		<div id="output"></div>
		<div id="footer">
			<p><p>
				<form>
					<!--
						 <p><input id="input" type="text" value="">
						 <button id="send">request</button>
						 <p>
					   -->
					<button id="play" disabled>Listen to Event Stream</button>
				</form>
		</div>
	</body>
</html>
